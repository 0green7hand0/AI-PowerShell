# AI PowerShell 智能助手 - 复杂场景模拟

## 🎬 场景背景

**用户：** 小李，一名运维工程师  
**时间：** 周一早上 9:00  
**任务：** 服务器性能异常，需要排查问题  
**问题：** 用户反馈系统响应慢，需要快速定位原因

---

## 📝 完整操作流程

### 第一步：启动程序并开始排查

```bash
PS D:\MCP_PowerShell> python -m src.main
```

**程序输出：**
```
============================================================
🚀 AI PowerShell 智能助手 - 交互模式
============================================================
输入中文描述，我会帮你生成并执行 PowerShell 命令
特殊命令: exit/quit/退出 - 退出程序
         help/帮助 - 显示帮助
         history/历史 - 显示命令历史
         clear/清屏 - 清空屏幕
============================================================

💬 请输入 >
```

---

### 第二步：查看 CPU 使用情况

**用户输入：**
```
显示CPU使用率最高的10个进程
```

**程序处理流程：**

```
[日志] 2025-10-07 09:00:15 - User request: 显示CPU使用率最高的10个进程
[日志] 2025-10-07 09:00:15 - Translating input...
[日志] 2025-10-07 09:00:15 - Rule matched! (confidence: 90%)
[日志] 2025-10-07 09:00:15 - Generated command: Get-Process | Sort-Object CPU -Descending | Select-Object -First 10
[日志] 2025-10-07 09:00:15 - Security check: PASSED ✓
```

**程序显示：**
```
============================================================
🤖 AI 翻译结果
============================================================
原始输入: 显示CPU使用率最高的10个进程
生成命令: Get-Process | Sort-Object CPU -Descending | Select-Object -First 10
置信度: 90.00%
说明: 显示CPU使用率最高的进程

风险等级: 🟢 安全
============================================================

是否执行此命令? (y/N): y
```

**执行结果：**
```
------------------------------------------------------------
✅ 执行成功

📄 输出:
Handles  NPM(K)    PM(K)      WS(K)     CPU(s)     Id  SI ProcessName
-------  ------    -----      -----     ------     --  -- -----------
   1245      89   856432    1024568     856.23   5432   1 sqlservr
    892      67   654321     892456     654.89   3421   1 w3wp
    567      45   432198     567890     432.45   2341   1 java
    445      34   321987     445678     321.67   1234   1 node
    334      28   234876     334567     234.56   4567   1 chrome
    223      19   198765     223456     198.34   6789   1 Teams
    156      15   156789     156789     156.23   8901   1 Code
    123      12   123456     123456     123.12   9012   1 outlook
     98      10    98765      98765      98.45   1023   1 explorer
     67       8    67890      67890      67.23   2034   1 powershell

⏱️  执行时间: 0.234 秒
------------------------------------------------------------
```

**小李的发现：** SQL Server 进程 CPU 使用率异常高（856.23秒）！

---


### 第三步：深入查看 SQL Server 进程详情

**用户输入：**
```
查看进程ID为5432的详细信息
```

**程序处理流程：**
```
[日志] 2025-10-07 09:00:45 - User request: 查看进程ID为5432的详细信息
[日志] 2025-10-07 09:00:45 - Translating input...
[日志] 2025-10-07 09:00:45 - Rule match failed, calling AI model...
[日志] 2025-10-07 09:00:47 - AI model response received
[日志] 2025-10-07 09:00:47 - Generated command: Get-Process -Id 5432 | Format-List *
[日志] 2025-10-07 09:00:47 - Security check: PASSED ✓
```

**程序显示：**
```
============================================================
🤖 AI 翻译结果
============================================================
原始输入: 查看进程ID为5432的详细信息
生成命令: Get-Process -Id 5432 | Format-List *
置信度: 80.00%
说明: AI 生成的命令: Get-Process -Id 5432 | Format-List *

风险等级: 🟢 安全
============================================================

是否执行此命令? (y/N): y
```

**执行结果：**
```
------------------------------------------------------------
✅ 执行成功

📄 输出:
Name                       : sqlservr
Id                         : 5432
PriorityClass              : Normal
HandleCount                : 1245
WorkingSet                 : 1074790400  (1024 MB)
PeakWorkingSet             : 1288490188  (1228 MB)
VirtualMemorySize          : 2147483648  (2048 MB)
CPU                        : 856.234375
Path                       : C:\Program Files\Microsoft SQL Server\MSSQL15.MSSQLSERVER\MSSQL\Binn\sqlservr.exe
Company                    : Microsoft Corporation
StartTime                  : 2025-10-07 08:30:15
Threads                    : 156

⏱️  执行时间: 0.156 秒
------------------------------------------------------------
```

**小李的分析：** 进程启动时间是 08:30，运行了30分钟就累积了856秒CPU时间，确实异常！

---


### 第四步：检查内存使用情况

**用户输入：**
```
显示内存使用最多的前10个进程，包括进程名称和内存大小
```

**程序处理流程：**
```
[日志] 2025-10-07 09:01:20 - User request: 显示内存使用最多的前10个进程，包括进程名称和内存大小
[日志] 2025-10-07 09:01:20 - Translating input...
[日志] 2025-10-07 09:01:20 - Rule matched! (confidence: 90%)
[日志] 2025-10-07 09:01:20 - Generated command: Get-Process | Sort-Object WorkingSet -Descending | Select-Object -First 10 Name, @{Name="Memory(MB)";Expression={[math]::Round($_.WorkingSet/1MB,2)}}
[日志] 2025-10-07 09:01:20 - Security check: PASSED ✓
```

**执行结果：**
```
------------------------------------------------------------
✅ 执行成功

📄 输出:
Name          Memory(MB)
----          ----------
sqlservr         1024.56
chrome            892.34
Teams             654.23
Code              432.12
w3wp              321.45
java              234.67
node              198.34
outlook           156.78
firefox           123.45
explorer           98.23

⏱️  执行时间: 0.189 秒
------------------------------------------------------------
```

**小李的发现：** SQL Server 内存使用也很高，达到 1GB！

---


### 第五步：检查网络连接

**用户输入：**
```
显示所有建立的网络连接，按远程地址分组统计数量
```

**程序处理流程：**
```
[日志] 2025-10-07 09:02:05 - User request: 显示所有建立的网络连接，按远程地址分组统计数量
[日志] 2025-10-07 09:02:05 - Translating input...
[日志] 2025-10-07 09:02:05 - Rule match failed, calling AI model...
[日志] 2025-10-07 09:02:10 - AI model response received
[日志] 2025-10-07 09:02:10 - Generated command: Get-NetTCPConnection -State Established | Group-Object RemoteAddress | Sort-Object Count -Descending | Select-Object Count, Name
[日志] 2025-10-07 09:02:10 - Security check: PASSED ✓
```

**执行结果：**
```
------------------------------------------------------------
✅ 执行成功

📄 输出:
Count Name
----- ----
  156 192.168.1.100
   89 192.168.1.101
   67 192.168.1.102
   45 10.0.0.50
   34 10.0.0.51
   23 8.8.8.8
   12 1.1.1.1

⏱️  执行时间: 0.456 秒
------------------------------------------------------------
```

**小李的发现：** 有大量连接到 192.168.1.100（156个连接），可能是数据库服务器！

---


### 第六步：检查磁盘空间

**用户输入：**
```
显示所有磁盘的使用情况，包括总容量、已用空间和剩余空间
```

**程序处理流程：**
```
[日志] 2025-10-07 09:03:00 - User request: 显示所有磁盘的使用情况，包括总容量、已用空间和剩余空间
[日志] 2025-10-07 09:03:00 - Translating input...
[日志] 2025-10-07 09:03:00 - Rule match failed, calling AI model...
[日志] 2025-10-07 09:03:05 - AI model response received
[日志] 2025-10-07 09:03:05 - Generated command: Get-PSDrive -PSProvider FileSystem | Select-Object Name, @{Name="Used(GB)";Expression={[math]::Round($_.Used/1GB,2)}}, @{Name="Free(GB)";Expression={[math]::Round($_.Free/1GB,2)}}, @{Name="Total(GB)";Expression={[math]::Round(($_.Used+$_.Free)/1GB,2)}}
[日志] 2025-10-07 09:03:05 - Security check: PASSED ✓
```

**执行结果：**
```
------------------------------------------------------------
✅ 执行成功

📄 输出:
Name Used(GB) Free(GB) Total(GB)
---- -------- -------- ---------
C       456.78    43.22    500.00
D       892.34   107.66   1000.00
E       234.56   265.44    500.00

⏱️  执行时间: 0.234 秒
------------------------------------------------------------
```

**小李的发现：** C盘空间紧张，只剩43GB！可能影响系统性能。

---


### 第七步：查找大文件

**用户输入：**
```
在C盘查找大于1GB的文件，显示前20个
```

**程序处理流程：**
```
[日志] 2025-10-07 09:04:00 - User request: 在C盘查找大于1GB的文件，显示前20个
[日志] 2025-10-07 09:04:00 - Translating input...
[日志] 2025-10-07 09:04:00 - Rule match failed, calling AI model...
[日志] 2025-10-07 09:04:05 - AI model response received
[日志] 2025-10-07 09:04:05 - Generated command: Get-ChildItem C:\ -Recurse -File -ErrorAction SilentlyContinue | Where-Object {$_.Length -gt 1GB} | Sort-Object Length -Descending | Select-Object -First 20 FullName, @{Name="Size(GB)";Expression={[math]::Round($_.Length/1GB,2)}}
[日志] 2025-10-07 09:04:05 - Security check: PASSED ✓
```

**程序显示：**
```
============================================================
🤖 AI 翻译结果
============================================================
原始输入: 在C盘查找大于1GB的文件，显示前20个
生成命令: Get-ChildItem C:\ -Recurse -File -ErrorAction SilentlyContinue | Where-Object {$_.Length -gt 1GB} | Sort-Object Length -Descending | Select-Object -First 20 FullName, @{Name="Size(GB)";Expression={[math]::Round($_.Length/1GB,2)}}
置信度: 80.00%
说明: AI 生成的命令

⚠️  警告:
  - 此命令可能需要较长时间执行
  - 递归搜索整个C盘

风险等级: 🟡 低风险
============================================================

是否执行此命令? (y/N): y
```

**执行结果：**
```
------------------------------------------------------------
✅ 执行成功

📄 输出:
FullName                                                    Size(GB)
--------                                                    --------
C:\pagefile.sys                                                16.00
C:\hiberfil.sys                                                12.00
C:\Program Files\SQL Server\Data\master.mdf                     8.50
C:\Program Files\SQL Server\Data\tempdb.mdf                     6.75
C:\Program Files\SQL Server\Log\tempdb.ldf                      5.25
C:\Windows\System32\config\SOFTWARE                             3.20
C:\Users\Administrator\AppData\Local\Temp\dump.dmp              2.80
C:\Logs\application.log                                         2.50
C:\Backup\database_backup_20251006.bak                          2.30
C:\Program Files\Docker\windowsfilter\layer.vhdx               1.95

⏱️  执行时间: 45.678 秒
------------------------------------------------------------
```

**小李的发现：** 
- 找到了问题！tempdb 数据库文件异常大（6.75GB）
- 还有一个2.8GB的dump文件
- 日志文件也很大（2.5GB）

---


### 第八步：查看系统服务状态

**用户输入：**
```
显示所有正在运行的服务，按名称排序
```

**程序处理流程：**
```
[日志] 2025-10-07 09:05:30 - User request: 显示所有正在运行的服务，按名称排序
[日志] 2025-10-07 09:05:30 - Translating input...
[日志] 2025-10-07 09:05:30 - Rule matched! (confidence: 95%)
[日志] 2025-10-07 09:05:30 - Generated command: Get-Service | Where-Object {$_.Status -eq 'Running'} | Sort-Object Name
[日志] 2025-10-07 09:05:30 - Security check: PASSED ✓
```

**执行结果：**
```
------------------------------------------------------------
✅ 执行成功

📄 输出:
Status   Name               DisplayName
------   ----               -----------
Running  AppHostSvc         Application Host Helper Service
Running  AudioSrv           Windows Audio
Running  BFE                Base Filtering Engine
Running  BITS               Background Intelligent Transfer Ser...
Running  Browser            Computer Browser
Running  CryptSvc           Cryptographic Services
Running  DcomLaunch         DCOM Server Process Launcher
Running  Dhcp               DHCP Client
Running  Dnscache           DNS Client
Running  EventLog           Windows Event Log
Running  MSSQLSERVER        SQL Server (MSSQLSERVER)
Running  W3SVC              World Wide Web Publishing Service
Running  WinRM              Windows Remote Management (WS-Manag...
... (共 89 个服务)

⏱️  执行时间: 0.345 秒
------------------------------------------------------------
```

---


### 第九步：查看历史命令

**用户输入：**
```
history
```

**程序输出：**
```
============================================================
📜 命令历史
============================================================
1. ✅ 显示CPU使用率最高的10个进程
   命令: Get-Process | Sort-Object CPU -Descending | Select-Object -First 10
   时间: 2025-10-07 09:00:15

2. ✅ 查看进程ID为5432的详细信息
   命令: Get-Process -Id 5432 | Format-List *
   时间: 2025-10-07 09:00:45

3. ✅ 显示内存使用最多的前10个进程，包括进程名称和内存大小
   命令: Get-Process | Sort-Object WorkingSet -Descending | Select-Object -First 10 Name, @{Name="Memory(MB)";Expression={[math]::Round($_.WorkingSet/1MB,2)}}
   时间: 2025-10-07 09:01:20

4. ✅ 显示所有建立的网络连接，按远程地址分组统计数量
   命令: Get-NetTCPConnection -State Established | Group-Object RemoteAddress | Sort-Object Count -Descending | Select-Object Count, Name
   时间: 2025-10-07 09:02:05

5. ✅ 显示所有磁盘的使用情况，包括总容量、已用空间和剩余空间
   命令: Get-PSDrive -PSProvider FileSystem | Select-Object Name, @{Name="Used(GB)";Expression={[math]::Round($_.Used/1GB,2)}}, @{Name="Free(GB)";Expression={[math]::Round($_.Free/1GB,2)}}, @{Name="Total(GB)";Expression={[math]::Round(($_.Used+$_.Free)/1GB,2)}}
   时间: 2025-10-07 09:03:00

6. ✅ 在C盘查找大于1GB的文件，显示前20个
   命令: Get-ChildItem C:\ -Recurse -File -ErrorAction SilentlyContinue | Where-Object {$_.Length -gt 1GB} | Sort-Object Length -Descending | Select-Object -First 20 FullName, @{Name="Size(GB)";Expression={[math]::Round($_.Length/1GB,2)}}
   时间: 2025-10-07 09:04:00

7. ✅ 显示所有正在运行的服务，按名称排序
   命令: Get-Service | Where-Object {$_.Status -eq 'Running'} | Sort-Object Name
   时间: 2025-10-07 09:05:30

============================================================
```

---


### 第十步：生成诊断报告

**用户输入：**
```
把当前系统的CPU、内存、磁盘信息导出到桌面的report.txt文件
```

**程序处理流程：**
```
[日志] 2025-10-07 09:06:30 - User request: 把当前系统的CPU、内存、磁盘信息导出到桌面的report.txt文件
[日志] 2025-10-07 09:06:30 - Translating input...
[日志] 2025-10-07 09:06:30 - Rule match failed, calling AI model...
[日志] 2025-10-07 09:06:35 - AI model response received
[日志] 2025-10-07 09:06:35 - Generated command: Get-ComputerInfo | Select-Object CsProcessors, OsTotalVisibleMemorySize, OsFreePhysicalMemory | Out-File "$env:USERPROFILE\Desktop\report.txt"
[日志] 2025-10-07 09:06:35 - Security check: PASSED ✓
```

**程序显示：**
```
============================================================
🤖 AI 翻译结果
============================================================
原始输入: 把当前系统的CPU、内存、磁盘信息导出到桌面的report.txt文件
生成命令: Get-ComputerInfo | Select-Object CsProcessors, OsTotalVisibleMemorySize, OsFreePhysicalMemory | Out-File "$env:USERPROFILE\Desktop\report.txt"
置信度: 80.00%
说明: AI 生成的命令

⚠️  警告:
  - 此命令会创建/覆盖文件

风险等级: 🟡 低风险
============================================================

是否执行此命令? (y/N): y
```

**执行结果：**
```
------------------------------------------------------------
✅ 执行成功

📄 输出:
报告已生成: C:\Users\Administrator\Desktop\report.txt

⏱️  执行时间: 2.345 秒
------------------------------------------------------------
```

---


### 第十一步：退出程序

**用户输入：**
```
exit
```

**程序输出：**
```
👋 再见！

[日志] 2025-10-07 09:07:00 - Session terminated
[日志] 2025-10-07 09:07:00 - Session duration: 6 minutes 45 seconds
[日志] 2025-10-07 09:07:00 - Commands executed: 8
[日志] 2025-10-07 09:07:00 - Success rate: 100%
```

---

## 📊 场景分析总结

### 问题诊断结果

小李通过 AI PowerShell 助手，在不到7分钟内完成了完整的系统诊断：

#### 🔍 发现的问题：

1. **SQL Server 进程异常**
   - CPU 使用率: 856秒（异常高）
   - 内存占用: 1024 MB
   - 运行时间: 30分钟

2. **磁盘空间紧张**
   - C盘剩余: 43 GB / 500 GB (仅8.6%)
   - tempdb 文件: 6.75 GB（异常大）
   - 日志文件: 2.5 GB

3. **网络连接异常**
   - 到数据库服务器的连接: 156个（过多）

#### 💡 解决方案：

1. 清理 tempdb 数据库
2. 删除不必要的dump文件和日志
3. 优化数据库查询，减少连接数
4. 增加C盘空间或迁移数据

---


## 🎯 技术亮点展示

### 1. 智能翻译能力

| 用户输入 | 翻译方式 | 置信度 | 耗时 |
|---------|---------|--------|------|
| 显示CPU使用率最高的10个进程 | 规则匹配 | 90% | 0.1秒 |
| 查看进程ID为5432的详细信息 | AI模型 | 80% | 2秒 |
| 显示内存使用最多的前10个进程 | 规则匹配 | 90% | 0.1秒 |
| 显示所有建立的网络连接 | AI模型 | 80% | 5秒 |
| 在C盘查找大于1GB的文件 | AI模型 | 80% | 5秒 |

### 2. 安全保护机制

所有命令都经过三层安全检查：

```
用户输入
   ↓
[第一层] 命令白名单验证
   ↓
[第二层] 危险模式检测
   ↓
[第三层] 权限检查
   ↓
安全 → 执行
不安全 → 阻止
```

### 3. 上下文感知

程序记住了整个会话的历史：
- 第2步查看了CPU使用率
- 第3步深入查看了特定进程
- 第4步检查了内存
- 每一步都基于前面的发现

### 4. 错误处理

```
[场景] 如果用户输入了不存在的命令
用户: "显示系统的超级信息"
   ↓
AI生成: Get-SuperInfo (不存在的命令)
   ↓
执行失败: 命令不存在
   ↓
程序提示: "命令执行失败，请尝试其他描述"
   ↓
不会崩溃，继续运行 ✓
```

---


## 📈 性能统计

### 整个会话的性能数据

```
会话时长: 6分45秒
执行命令: 8条
成功率: 100%

命令类型分布:
├─ 规则匹配: 3条 (37.5%) - 平均耗时 0.2秒
├─ AI生成: 5条 (62.5%) - 平均耗时 3.5秒
└─ 缓存命中: 0条 (0%)

总执行时间: 56.8秒
├─ 翻译时间: 17.5秒 (30.8%)
├─ 安全检查: 0.8秒 (1.4%)
├─ 命令执行: 38.5秒 (67.8%)
└─ 用户确认: 等待用户输入

最慢的命令:
1. 查找大文件: 45.7秒
2. 磁盘信息: 2.3秒
3. 网络连接: 0.5秒
```

---

## 🔄 与传统方式对比

### 传统方式（手动输入PowerShell命令）

```
小李需要：
1. 记住 Get-Process 的语法 ❌
2. 记住 Sort-Object 的参数 ❌
3. 记住 Select-Object 的用法 ❌
4. 手动输入完整命令 ❌
5. 如果出错，查文档重新输入 ❌

预计耗时: 20-30分钟
出错概率: 高
```

### 使用 AI PowerShell 助手

```
小李只需要：
1. 用中文描述需求 ✓
2. 确认执行 ✓
3. 查看结果 ✓

实际耗时: 6分45秒
出错概率: 低（有安全检查）
学习成本: 零
```

**效率提升: 3-4倍！**

---


## 🎓 从这个场景学到什么？

### 1. 程序的核心价值

**降低技术门槛**
- 不需要记住复杂的PowerShell语法
- 用自然语言就能完成专业操作
- 新手也能像专家一样工作

**提高工作效率**
- 快速诊断系统问题
- 减少查文档的时间
- 避免命令输入错误

**保证操作安全**
- 自动检测危险命令
- 需要确认才执行
- 完整的操作日志

### 2. 适用场景

✅ **系统运维**
- 性能监控
- 故障排查
- 日志分析

✅ **日常管理**
- 文件管理
- 进程管理
- 服务管理

✅ **自动化任务**
- 批量操作
- 定期检查
- 报告生成

### 3. 最佳实践

**DO（推荐做法）：**
- ✓ 使用清晰的中文描述
- ✓ 一次只做一件事
- ✓ 查看历史命令学习
- ✓ 重要操作前确认

**DON'T（不推荐）：**
- ✗ 描述过于模糊
- ✗ 跳过安全确认
- ✗ 不查看执行结果
- ✗ 盲目信任AI生成的命令

---
