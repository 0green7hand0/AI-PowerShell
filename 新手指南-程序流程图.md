# AI PowerShell 智能助手 - 新手指南

## 📖 这个项目是做什么的？

这是一个**智能翻译器**，可以把你说的中文话，自动翻译成电脑能理解的 PowerShell 命令。

**举个例子：**
- 你说："显示当前时间"
- 程序翻译成：`Get-Date`
- 电脑执行后显示：`2025年10月7日 9:50:54`

---

## 🔄 完整流程图

```
┌─────────────────────────────────────────────────────────────┐
│                    1. 用户输入中文                            │
│                                                               │
│  例如："显示CPU使用率最高的5个进程"                           │
└────────────────────┬────────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────────┐
│              2. 主控制器 (PowerShellAssistant)                │
│                                                               │
│  • 接收用户输入                                               │
│  • 生成唯一ID追踪这次请求                                     │
│  • 记录日志                                                   │
└────────────────────┬────────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────────┐
│              3. 上下文管理器 (ContextManager)                 │
│                                                               │
│  • 获取当前会话信息                                           │
│  • 查看最近执行过的命令（历史记录）                           │
│  • 提供上下文给AI参考                                         │
└────────────────────┬────────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────────┐
│                4. AI 引擎 (AIEngine)                          │
│                                                               │
│  第一步：检查缓存                                             │
│  ├─ 如果之前翻译过相同的话 → 直接返回结果 ✓                  │
│  └─ 如果是新的话 → 继续下一步                                │
│                                                               │
│  第二步：尝试规则匹配（快速）                                 │
│  ├─ 匹配成功 → 返回命令 ✓                                    │
│  └─ 匹配失败 → 继续下一步                                    │
│                                                               │
│  第三步：调用 AI 模型（你的 qwen3:30b）                      │
│  ├─ 构建提示词                                                │
│  ├─ 发送给 Ollama 服务                                        │
│  ├─ 等待 AI 生成命令                                          │
│  └─ 返回生成的命令 ✓                                         │
│                                                               │
│  第四步：错误检测                                             │
│  └─ 检查命令语法是否正确                                      │
└────────────────────┬────────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────────┐
│             5. 安全引擎 (SecurityEngine)                      │
│                                                               │
│  • 检查命令是否安全                                           │
│  • 是否是危险操作（如删除系统文件）                           │
│  • 是否需要管理员权限                                         │
│  • 是否需要用户确认                                           │
│                                                               │
│  如果不安全 → 阻止执行 ✗                                      │
│  如果安全 → 继续下一步 ✓                                      │
└────────────────────┬────────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────────┐
│                  6. 用户确认（可选）                          │
│                                                               │
│  显示给用户：                                                 │
│  ┌─────────────────────────────────────────┐                │
│  │ 原始输入: 显示CPU使用率最高的5个进程    │                │
│  │ 生成命令: Get-Process | Sort-Object ... │                │
│  │ 置信度: 90%                              │                │
│  │ 风险等级: 🟢 安全                        │                │
│  │                                          │                │
│  │ 是否执行此命令? (y/N):                  │                │
│  └─────────────────────────────────────────┘                │
│                                                               │
│  用户输入 y → 继续执行 ✓                                      │
│  用户输入 N → 取消执行 ✗                                      │
└────────────────────┬────────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────────┐
│              7. 执行引擎 (CommandExecutor)                    │
│                                                               │
│  • 检测 PowerShell 版本（pwsh 或 powershell）                │
│  • 执行命令                                                   │
│  • 设置超时时间（默认30秒）                                   │
│  • 捕获输出和错误                                             │
│  • 记录执行时间                                               │
└────────────────────┬────────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────────┐
│                  8. 返回结果给用户                            │
│                                                               │
│  成功示例：                                                   │
│  ┌─────────────────────────────────────────┐                │
│  │ ✅ 执行成功                              │                │
│  │                                          │                │
│  │ 📄 输出:                                 │                │
│  │ Handles  NPM(K)  PM(K)  WS(K)  CPU(s)   │                │
│  │ -------  ------  -----  -----  ------   │                │
│  │     464      31 249492 306340  205.44   │                │
│  │     544     183 251280 026548  125.14   │                │
│  │                                          │                │
│  │ ⏱️  执行时间: 0.235 秒                   │                │
│  └─────────────────────────────────────────┘                │
│                                                               │
│  失败示例：                                                   │
│  ┌─────────────────────────────────────────┐                │
│  │ ❌ 执行失败                              │                │
│  │                                          │                │
│  │ 🚫 错误:                                 │                │
│  │ 命令不存在或语法错误                     │                │
│  └─────────────────────────────────────────┘                │
└────────────────────┬────────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────────┐
│              9. 保存历史记录和更新上下文                      │
│                                                               │
│  • 保存到历史记录文件                                         │
│  • 更新会话上下文                                             │
│  • 供下次使用参考                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 🎯 三种翻译策略详解

### 策略 1: 规则匹配（最快）⚡

**工作原理：** 使用预定义的正则表达式模式匹配

**示例：**
```
用户输入: "显示当前时间"
匹配规则: (显示|查看|获取).*(时间|日期)
生成命令: Get-Date
置信度: 95%
```

**优点：** 速度快（< 0.1秒），准确度高
**缺点：** 只能处理预定义的常见命令

---

### 策略 2: AI 模型（智能）🤖

**工作原理：** 调用你本地的 Ollama qwen3:30b 模型

**示例：**
```
用户输入: "帮我查看一下内存使用情况"
↓
发送给 AI 模型（附带提示词和示例）
↓
AI 生成: Get-ComputerInfo | Select-Object -Property WindowsMemoryLoad...
置信度: 80%
```

**优点：** 能理解复杂的、不常见的描述
**缺点：** 速度较慢（1-5秒），需要 Ollama 服务运行

---

### 策略 3: 回退策略（保底）🔄

**工作原理：** 简单的关键词匹配

**示例：**
```
用户输入: "xxx内存xxx"
检测到关键词: "内存"
生成命令: Get-Process
置信度: 60%
```

**优点：** 保证系统始终可用
**缺点：** 准确度较低

---

## 📁 核心模块说明

### 1. 主控制器 (src/main.py)
- **作用：** 总指挥，协调所有模块
- **比喻：** 像乐队指挥，让各个乐器（模块）协同工作

### 2. AI 引擎 (src/ai_engine/)
- **作用：** 翻译中文到 PowerShell 命令
- **比喻：** 像翻译官，把中文翻译成电脑语言

### 3. 安全引擎 (src/security/)
- **作用：** 检查命令是否安全
- **比喻：** 像保安，防止危险操作

### 4. 执行引擎 (src/execution/)
- **作用：** 实际执行 PowerShell 命令
- **比喻：** 像工人，真正干活的

### 5. 配置管理 (src/config/)
- **作用：** 管理所有设置
- **比喻：** 像设置面板，控制程序行为

### 6. 日志引擎 (src/log_engine/)
- **作用：** 记录所有操作
- **比喻：** 像日记本，记录发生的事情

### 7. 存储引擎 (src/storage/)
- **作用：** 保存历史记录
- **比喻：** 像档案柜，存储过去的数据

### 8. 上下文管理 (src/context/)
- **作用：** 管理会话和历史
- **比喻：** 像记忆，记住之前做过什么

---

## 🚀 实际使用示例

### 示例 1: 查看时间

```
你输入: 显示当前时间
         ↓
规则匹配: 匹配成功 ✓
         ↓
生成命令: Get-Date
         ↓
安全检查: 安全 ✓
         ↓
执行命令: 运行 Get-Date
         ↓
输出结果: 2025年10月7日 9:50:54
```

**耗时：** 约 0.2 秒

---

### 示例 2: 查看进程（复杂命令）

```
你输入: 显示CPU使用率最高的5个进程
         ↓
规则匹配: 匹配成功 ✓
         ↓
生成命令: Get-Process | Sort-Object CPU -Descending | Select-Object -First 5
         ↓
安全检查: 安全 ✓
         ↓
用户确认: 是否执行? (y/N): y
         ↓
执行命令: 运行命令
         ↓
输出结果: 显示进程列表
```

**耗时：** 约 0.3 秒

---

### 示例 3: 不常见命令（需要 AI）

```
你输入: 帮我查看一下内存使用情况
         ↓
规则匹配: 匹配失败 ✗
         ↓
调用 AI: 发送给 qwen3:30b
         ↓ (等待 AI 思考)
生成命令: Get-ComputerInfo | Select-Object -Property WindowsMemoryLoad...
         ↓
安全检查: 安全 ✓
         ↓
执行命令: 运行命令
         ↓
输出结果: 显示内存信息
```

**耗时：** 约 3-5 秒（AI 处理时间）

---

## 🔧 配置文件说明

### config/default.yaml

```yaml
ai:
  provider: ollama          # 使用 Ollama（你的本地 AI）
  model_name: qwen3:30b     # 使用千问3模型
  use_ai_provider: true     # 启用 AI（重要！）
  
security:
  require_confirmation: true  # 执行前需要确认
  
execution:
  timeout: 30               # 命令最多执行30秒
```

---

## 💡 常见问题

### Q1: 为什么有些命令很快，有些很慢？

**答：** 
- **快的命令**：使用规则匹配，不需要 AI
- **慢的命令**：需要调用 AI 模型，需要思考时间

### Q2: AI 模型什么时候会被调用？

**答：** 当规则匹配失败时，比如：
- 不常见的描述
- 复杂的需求
- 没有预定义规则的命令

### Q3: 如何让程序更快？

**答：** 
1. 使用常见的描述（会命中规则匹配）
2. 启用缓存（重复的命令会直接返回）
3. 使用更快的 AI 模型

### Q4: 程序会执行危险命令吗？

**答：** 不会！安全引擎会：
- 阻止危险命令（如删除系统文件）
- 需要用户确认才执行
- 记录所有操作日志

---

## 📊 性能数据

| 操作类型 | 平均耗时 | 说明 |
|---------|---------|------|
| 规则匹配 | < 0.1秒 | 最快 |
| AI 生成 | 1-5秒 | 取决于模型和硬件 |
| 命令执行 | 0.1-30秒 | 取决于具体命令 |
| 缓存命中 | < 0.05秒 | 最快 |

---

## 🎓 总结

这个项目就像一个**智能翻译器 + 安全卫士**：

1. **你说中文** → 程序理解
2. **程序翻译** → 生成 PowerShell 命令
3. **安全检查** → 确保不会搞破坏
4. **执行命令** → 得到结果
5. **显示结果** → 你看到输出

**核心优势：**
- ✅ 本地运行，保护隐私
- ✅ 智能翻译，理解中文
- ✅ 安全保护，防止误操作
- ✅ 快速响应，体验流畅

希望这个指南能帮助你理解整个程序的工作流程！🎉
