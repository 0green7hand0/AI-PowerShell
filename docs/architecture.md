# AI PowerShell 智能助手 - 架构文档

## 概述

AI PowerShell 智能助手是一个基于本地 AI 模型的智能命令行助手，采用模块化架构设计，支持中文自然语言交互，提供三层安全保护机制。

### 设计目标

1. **模块化**: 采用高内聚低耦合的模块化架构，便于维护和扩展
2. **简洁性**: 提供简单易用的用户界面和清晰的代码结构
3. **安全性**: 实施三层安全保护，确保命令执行的安全性
4. **隐私保护**: 所有 AI 处理在本地进行，不上传用户数据
5. **跨平台**: 支持 Windows、Linux 和 macOS
6. **可扩展性**: 支持添加自定义规则和集成不同的 AI 模型

### 核心特性

- 中文自然语言到 PowerShell 命令的智能转换
- 基于规则匹配和 AI 模型的混合翻译策略
- 模块化架构设计，高内聚低耦合
- 三层安全验证：命令白名单、权限检查、沙箱执行
- 跨平台 PowerShell 支持（PowerShell 5.1 和 PowerShell Core）
- 完整的审计日志和性能监控
- 本地 AI 模型集成（LLaMA、Ollama 等）

## 系统架构

### 整体架构图

```
┌─────────────────────────────────────────────────────────────┐
│                    用户接口层 (User Interface)                │
│  ┌─────────────┬─────────────┬─────────────────────────────┐ │
│  │ 命令行界面   │  交互模式    │  Python API                 │ │
│  │   (CLI)     │ (Interactive)│  (API)                      │ │
│  └─────────────┴─────────────┴─────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│                  核心处理层 (Core Processing)                 │
│  ┌──────────────────────────────────────────────────────┐   │
│  │           PowerShellAssistant (主控制器)              │   │
│  │  - 协调各组件工作                                      │   │
│  │  - 管理请求处理流程                                    │   │
│  │  - 提供统一的接口                                      │   │
│  └──────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
                            │
        ┌───────────────────┼───────────────────┐
        ▼                   ▼                   ▼
┌──────────────┐   ┌──────────────┐   ┌──────────────┐
│  AI 引擎      │   │  安全引擎     │   │  执行引擎     │
│ (AI Engine)  │   │(Security Eng.)│   │(Exec Engine) │
└──────────────┘   └──────────────┘   └──────────────┘
        │                   │                   │
        └───────────────────┼───────────────────┘
                            ▼
┌─────────────────────────────────────────────────────────────┐
│                   支持模块层 (Support Modules)                │
│  ┌─────────────┬─────────────┬─────────────┬─────────────┐   │
│  │  配置管理    │  日志引擎    │  存储引擎    │  上下文管理  │   │
│  │  (Config)   │  (Logging)  │  (Storage)  │  (Context)  │   │
│  └─────────────┴─────────────┴─────────────┴─────────────┘   │
└─────────────────────────────────────────────────────────────┘
```

### 模块化架构

项目采用高内聚低耦合的模块化架构设计：

**架构特点**:
- 清晰的模块划分，每个模块职责单一
- 模块间通过接口通信，降低耦合
- 支持多种 AI 模型集成
- 完整的三层安全保护
- 沙箱执行支持
- 完整的日志和审计系统

**模块结构**:
```
src/
├── interfaces/          # 接口定义层
│   └── base.py         # 基础接口和数据模型
├── ai_engine/          # AI 引擎模块
│   ├── engine.py       # AI 引擎主类
│   ├── translation.py  # 翻译逻辑
│   ├── providers.py    # AI 提供商
│   └── error_detection.py  # 错误检测
├── security/           # 安全引擎模块
│   ├── engine.py       # 安全引擎主类
│   ├── whitelist.py    # 命令白名单
│   ├── permissions.py  # 权限检查
│   └── sandbox.py      # 沙箱执行
├── execution/          # 执行引擎模块
│   ├── executor.py     # 执行器主类
│   ├── platform_adapter.py  # 平台适配
│   └── output_formatter.py  # 输出格式化
├── config/             # 配置管理模块
│   ├── manager.py      # 配置管理器
│   └── models.py       # 配置数据模型
├── log_engine/         # 日志引擎模块
│   ├── engine.py       # 日志引擎主类
│   ├── decorators.py   # 日志装饰器
│   └── filters.py      # 日志过滤器
├── storage/            # 存储引擎模块
│   ├── interfaces.py   # 存储接口
│   ├── file_storage.py # 文件存储实现
│   └── factory.py      # 存储工厂
├── context/            # 上下文管理模块
│   ├── manager.py      # 上下文管理器
│   ├── history.py      # 历史记录
│   └── models.py       # 上下文数据模型
└── main.py             # 主入口文件
```

## 核心组件详解

### 1. 接口定义层 (Interfaces)

**位置**: `src/interfaces/`

**职责**: 定义所有模块间的接口和数据模型

**核心接口**:
- `AIEngineInterface`: AI 引擎接口
- `SecurityEngineInterface`: 安全引擎接口
- `ExecutorInterface`: 执行器接口
- `StorageInterface`: 存储接口

**数据模型**:
- `Suggestion`: 命令建议
- `ValidationResult`: 验证结果
- `ExecutionResult`: 执行结果
- `Context`: 上下文信息

**设计原则**:
- 使用抽象基类定义接口
- 数据类使用 `@dataclass` 装饰器
- 类型提示确保类型安全
- 接口与实现分离

### 2. AI 引擎 (AI Engine)

**位置**: `src/ai_engine/`

**职责**: 将中文自然语言转换为 PowerShell 命令

**组件**:
- `engine.py`: AI 引擎主类，协调翻译流程
- `translation.py`: 翻译逻辑和规则匹配
- `providers.py`: AI 提供商（LLaMA、Ollama 等）
- `error_detection.py`: 错误检测和修正

**工作流程**:
1. 接收用户的自然语言输入
2. 检查缓存是否有匹配结果
3. 尝试规则匹配（快速路径）
4. 如果规则匹配失败，使用 AI 模型生成
5. 错误检测和修正
6. 缓存结果并返回

**特点**:
- 规则匹配和 AI 模型结合
- 支持多种 AI 提供商
- 上下文感知
- 置信度评分
- 缓存机制

### 3. 安全引擎 (Security Engine)

**位置**: `src/security/`

**职责**: 三层安全验证和沙箱执行

**组件**:
- `engine.py`: 安全引擎主类，协调三层验证
- `whitelist.py`: 命令白名单验证
- `permissions.py`: 权限检查和确认
- `sandbox.py`: Docker 沙箱执行

**三层安全架构**:

```
第一层：命令白名单验证
  ├─ 检查危险命令模式
  ├─ 识别安全命令前缀
  └─ 风险等级评估
         │
         ▼
第二层：权限检查
  ├─ 检测管理员权限需求
  ├─ 用户确认流程
  └─ 权限提升日志
         │
         ▼
第三层：沙箱执行（可选）
  ├─ Docker 容器隔离
  ├─ 资源限制
  └─ 网络隔离
```

**特点**:
- 可配置的安全规则
- 智能风险评估
- 完整审计日志
- 沙箱隔离支持

### 4. 执行引擎 (Execution Engine)

**位置**: `src/execution/`

**职责**: 跨平台 PowerShell 命令执行

**组件**:
- `executor.py`: 执行器主类
- `platform_adapter.py`: 平台适配器
- `output_formatter.py`: 输出格式化

**工作流程**:
1. 接收待执行的 PowerShell 命令
2. 平台检测和适配
3. 执行命令并捕获输出
4. 格式化输出结果
5. 错误处理和日志记录

**特点**:
- 自动平台检测（Windows/Linux/macOS）
- PowerShell 版本自动选择
- 中文编码支持
- 超时控制
- 输出格式化

### 5. 配置管理 (Configuration Management)

**位置**: `src/config/`

**职责**: 系统配置和验证

**组件**:
- `manager.py`: 配置管理器
- `models.py`: 配置数据模型（使用 Pydantic）

**配置层级**:
- 默认配置（`config/default.yaml`）
- 用户配置（`~/.ai-powershell/config.yaml`）
- 环境变量覆盖
- 命令行参数覆盖

**特点**:
- YAML 配置文件
- Pydantic 数据验证
- 默认值支持
- 配置热重载

### 6. 日志引擎 (Logging Engine)

**位置**: `src/log_engine/`

**职责**: 全面的审计跟踪和性能监控

**组件**:
- `engine.py`: 日志引擎主类
- `decorators.py`: 日志装饰器
- `filters.py`: 日志过滤器

**日志类型**:
- 用户请求日志
- AI 翻译日志
- 安全验证日志
- 命令执行日志
- 性能监控日志

**特点**:
- 结构化日志（JSON 格式）
- 关联追踪（Correlation ID）
- 敏感信息过滤
- 多种输出目标
- 日志轮转

### 7. 存储引擎 (Storage Engine)

**位置**: `src/storage/`

**职责**: 配置管理和数据持久化

**组件**:
- `interfaces.py`: 存储接口定义
- `file_storage.py`: 文件存储实现
- `factory.py`: 存储工厂

**存储内容**:
- 用户配置
- 命令历史
- 缓存数据
- 审计日志

**特点**:
- 支持多种存储后端
- 自动备份
- 版本控制
- 数据迁移

### 8. 上下文管理 (Context Management)

**位置**: `src/context/`

**职责**: 会话管理和历史记录

**组件**:
- `manager.py`: 上下文管理器
- `history.py`: 历史记录管理
- `models.py`: 上下文数据模型

**功能**:
- 会话追踪
- 命令历史
- 上下文维护
- 智能推荐

**特点**:
- 会话隔离
- 历史查询
- 上下文感知
- 学习用户偏好

## 数据流和处理流程

### 完整请求处理流程

```
用户输入
   │
   ▼
┌─────────────────────┐
│  主控制器接收请求    │
│  PowerShellAssistant │
└─────────────────────┘
   │
   ▼
┌─────────────────────┐
│  AI 引擎翻译        │
│  - 规则匹配          │
│  - AI 模型生成       │
│  - 错误检测          │
└─────────────────────┘
   │
   ▼
┌─────────────────────┐
│  安全引擎验证        │
│  - 白名单检查        │
│  - 权限检查          │
│  - 沙箱执行（可选）  │
└─────────────────────┘
   │
   ▼
┌─────────────────────┐
│  用户确认            │
│  - 显示生成的命令    │
│  - 等待用户确认      │
└─────────────────────┘
   │
   ▼
┌─────────────────────┐
│  执行引擎执行        │
│  - 平台适配          │
│  - 命令执行          │
│  - 输出捕获          │
└─────────────────────┘
   │
   ▼
┌─────────────────────┐
│  结果处理            │
│  - 输出格式化        │
│  - 日志记录          │
│  - 历史保存          │
└─────────────────────┘
   │
   ▼
返回结果给用户
```

## 设计原则

### 1. 高内聚低耦合

- 每个模块职责单一明确
- 模块间通过接口通信
- 减少模块间的直接依赖

### 2. 接口与实现分离

- 定义清晰的接口层
- 实现可以灵活替换
- 便于测试和扩展

### 3. 依赖注入

- 通过构造函数注入依赖
- 便于单元测试
- 提高代码可维护性

### 4. 单一职责原则

- 每个类只负责一个功能
- 便于理解和维护
- 提高代码复用性

### 5. 开闭原则

- 对扩展开放
- 对修改关闭
- 通过继承和组合扩展功能

## 技术栈

### 核心技术

| 技术 | 版本 | 用途 |
|------|------|------|
| Python | 3.8+ | 主要编程语言 |
| PowerShell | 5.1+ / Core 7.0+ | 命令执行环境 |
| PyYAML | 6.0.1+ | 配置文件解析 |
| Pydantic | 2.0+ | 数据验证 |
| structlog | 23.1.0+ | 结构化日志 |

### AI 模型支持

| 模型 | 提供商 | 用途 |
|------|--------|------|
| LLaMA | Meta | 本地 AI 推理 |
| Ollama | Ollama | 本地模型运行 |
| llama-cpp-python | - | Python 绑定 |

### 安全和隔离

| 技术 | 版本 | 用途 |
|------|------|------|
| Docker | 20.10+ | 沙箱执行环境 |
| docker-py | 6.1.0+ | Docker Python SDK |

## 扩展性

### 添加新的 AI 提供商

1. 继承 `AIProvider` 抽象基类
2. 实现 `generate()` 方法
3. 在配置中注册新提供商

### 添加新的存储后端

1. 实现 `StorageInterface` 接口
2. 在 `StorageFactory` 中注册
3. 在配置中选择存储后端

### 添加自定义安全规则

1. 编辑 `config/default.yaml`
2. 添加危险模式或安全前缀
3. 重启应用生效

### 添加翻译规则

1. 编辑 `src/ai_engine/translation.py`
2. 在 `_load_rules()` 中添加规则
3. 使用正则表达式匹配

## 性能优化

### 缓存策略

- AI 翻译结果缓存
- 配置文件缓存
- 命令历史缓存

### 异步处理

- 日志异步写入
- 缓存异步更新
- 非阻塞 I/O

### 资源管理

- 连接池管理
- 内存限制
- 超时控制

## 安全考虑

### 输入验证

- 用户输入清理
- 命令参数验证
- SQL 注入防护

### 权限控制

- 最小权限原则
- 权限提升审计
- 用户确认机制

### 数据保护

- 敏感信息过滤
- 日志脱敏
- 本地数据加密

## 测试策略

### 单元测试

- 每个模块独立测试
- 使用 pytest 框架
- 目标覆盖率 > 80%

### 集成测试

- 模块间交互测试
- 端到端流程测试
- 性能基准测试

### 安全测试

- 危险命令阻止测试
- 权限检查测试
- 沙箱隔离测试

## 部署架构

### 单机部署

- 直接运行 Python 程序
- 适合个人用户
- 快速启动

### Docker 部署

- 容器化部署
- 环境隔离
- 易于管理

### Kubernetes 部署

- 企业级部署
- 高可用性
- 自动扩展

## 总结

AI PowerShell 智能助手采用模块化架构设计，通过高内聚低耦合的原则，实现了一个安全、可扩展、易维护的智能命令行助手系统。系统支持本地 AI 处理，保护用户隐私，提供三层安全保护，确保命令执行的安全性。

详细的开发指南请参考 [开发者指南](developer-guide.md)。
