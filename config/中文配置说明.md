# AI PowerShell 助手配置说明

本文档详细说明了 AI PowerShell 助手的各项配置选项。

## 配置文件结构

### 主配置文件 (config.yaml)

```yaml
# 系统信息
version: "1.0.0"        # 系统版本
platform: "auto"       # 平台类型：auto（自动检测）、windows、linux、macos

# 服务器配置
server:
  host: "0.0.0.0"              # 监听地址
  port: 8000                   # 监听端口
  max_concurrent_sessions: 50  # 最大并发会话数
  session_timeout: 3600        # 会话超时时间（秒）
  enable_cors: true            # 是否启用 CORS
  cors_origins: ["*"]          # CORS 允许的源

# MCP 服务器设置
mcp_server:
  name: "AI PowerShell Assistant"           # 服务器名称
  version: "1.0.0"                         # 服务器版本
  enable_natural_language_tool: true       # 启用自然语言工具
  enable_execute_command_tool: true        # 启用命令执行工具
  enable_system_info_tool: true           # 启用系统信息工具
  max_request_size: 10485760               # 最大请求大小（字节）
  request_timeout: 300                     # 请求超时时间（秒）

# PowerShell 配置
powershell:
  executable: "pwsh"           # PowerShell 可执行文件路径
  version_preference: "core"   # 版本偏好：core、desktop、any
  default_timeout: 60          # 默认超时时间（秒）
  max_output_size: 1048576     # 最大输出大小（字节）
  encoding: "utf-8"            # 编码格式

# AI 模型配置
ai_model:
  type: "llama-cpp"                                    # 模型类型
  model_path: "/app/models/llama-7b-chat.bin"        # 模型文件路径
  context_length: 4096                                # 上下文长度
  temperature: 0.5                                    # 温度参数（创造性）
  max_tokens: 256                                     # 最大生成令牌数
  batch_size: 8                                       # 批处理大小
  threads: 8                                          # CPU 线程数
  gpu_layers: 32                                      # GPU 层数（0=仅CPU）

# 安全配置
security:
  sandbox_enabled: true                               # 启用沙箱执行
  docker_image: "mcr.microsoft.com/powershell:ubuntu-20.04"  # Docker 镜像
  sandbox_timeout: 300                               # 沙箱超时时间（秒）
  sandbox_memory_limit: "512m"                       # 沙箱内存限制
  sandbox_cpu_limit: "1.0"                          # 沙箱 CPU 限制
  whitelist_enabled: true                            # 启用白名单验证
  whitelist_path: "/app/config/security-rules.yaml" # 安全规则文件路径
  require_confirmation_for_admin: true               # 管理员命令需要确认
  audit_enabled: true                                # 启用审计日志

# 存储配置
storage:
  data_directory: "/app/data"    # 数据目录
  log_directory: "/app/logs"     # 日志目录
  backup_enabled: true           # 启用备份
  backup_interval: 86400         # 备份间隔（秒）
  retention_days: 30             # 数据保留天数

# 日志配置
logging:
  level: "INFO"                    # 日志级别：DEBUG、INFO、WARNING、ERROR、CRITICAL
  format: "json"                   # 日志格式：json、text、structured
  outputs: ["file", "console"]    # 输出目标：file、console、syslog
  correlation_tracking: true       # 启用关联追踪
  performance_monitoring: true     # 启用性能监控
  audit_trail: true               # 启用审计轨迹
  sensitive_data_masking: true    # 启用敏感数据掩码

# 性能配置
performance:
  cache_enabled: true              # 启用缓存
  cache_size: 10000               # 缓存大小
  cache_ttl: 3600                 # 缓存生存时间（秒）
  connection_pool_size: 20        # 连接池大小
  garbage_collection_interval: 300  # 垃圾回收间隔（秒）
  memory_cleanup_interval: 600    # 内存清理间隔（秒）
```

### 安全规则配置 (security-rules.yaml)

```yaml
version: "1.0.0"
last_updated: "2024-01-15T10:30:45Z"

# 全局安全设置
global:
  default_action: "block"      # 默认动作：allow（允许）、block（阻止）、confirm（确认）
  risk_threshold: "medium"     # 风险阈值：low、medium、high、critical
  enable_learning: true        # 启用学习模式

# 命令分类
categories:
  safe_commands:                 # 安全命令
    description: "安全的只读命令"
    action: "allow"              # 动作：允许
    risk_level: "low"            # 风险等级：低
    patterns:                    # 匹配模式
      - "^Get-"                  # 以 Get- 开头的命令
      - "^Show-"                 # 以 Show- 开头的命令
      - "^Test-Connection"       # Test-Connection 命令
      - "^Measure-"              # 以 Measure- 开头的命令

  administrative_commands:       # 管理员命令
    description: "需要确认的管理员命令"
    action: "confirm"            # 动作：需要确认
    risk_level: "high"           # 风险等级：高
    patterns:
      - "^Set-"                  # 以 Set- 开头的命令
      - "^New-"                  # 以 New- 开头的命令
      - "^Remove-"               # 以 Remove- 开头的命令
      - "^Start-Service"         # 启动服务命令
      - "^Stop-Service"          # 停止服务命令
      - "^Restart-"              # 以 Restart- 开头的命令

  dangerous_commands:            # 危险命令
    description: "潜在危险的命令"
    action: "block"              # 动作：阻止
    risk_level: "critical"       # 风险等级：严重
    patterns:
      - "Remove-Item.*-Recurse"  # 递归删除命令
      - "Format-Volume"          # 格式化卷命令
      - "Clear-Host"             # 清屏命令
      - "rm -rf"                 # Linux 递归删除
      - "del /s"                 # Windows 递归删除

# 具体规则（覆盖分类设置）
rules:
  - name: "allow_process_management"     # 规则名称
    pattern: "^Get-Process"              # 匹配模式
    action: "allow"                      # 动作
    risk_level: "low"                    # 风险等级
    description: "允许进程列表查询"       # 描述

  - name: "block_system_shutdown"        # 阻止系统关机
    pattern: "Stop-Computer|Restart-Computer|shutdown"
    action: "block"
    risk_level: "critical"
    description: "阻止系统关机命令"

  - name: "confirm_service_changes"      # 确认服务更改
    pattern: "(Start|Stop|Restart)-Service"
    action: "confirm"
    risk_level: "high"
    description: "服务更改需要确认"
    confirmation_message: "此命令将修改系统服务。是否继续？"

# 用户特定规则
user_rules:
  admin_users:                          # 管理员用户
    - "administrator"
    - "root"
    additional_permissions:             # 额外权限
      - "administrative_commands"

  standard_users:                       # 标准用户
    - "*"                              # 所有其他用户
    restrictions:                       # 限制
      - "dangerous_commands"

# 基于上下文的规则
context_rules:
  working_directory:                    # 工作目录规则
    system_directories:                 # 系统目录
      paths: ["/system", "C:\\Windows", "/etc"]
      additional_restrictions: ["administrative_commands"]

  time_based:                          # 基于时间的规则
    business_hours:                     # 工作时间
      start: "09:00"
      end: "17:00"
      timezone: "UTC"
      relaxed_rules: true              # 宽松规则
```

## 配置最佳实践

### 开发环境配置
- 禁用沙箱以加快开发速度
- 启用详细日志记录
- 降低安全限制
- 使用较小的 AI 模型

### 生产环境配置
- 启用所有安全功能
- 使用高性能 AI 模型
- 启用 GPU 加速
- 配置适当的资源限制

### 安全配置建议
- 定期更新安全规则
- 监控审计日志
- 使用最小权限原则
- 启用沙箱执行

### 性能优化建议
- 根据硬件配置调整线程数
- 启用缓存机制
- 使用适当的模型大小
- 监控资源使用情况